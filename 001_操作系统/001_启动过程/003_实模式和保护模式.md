# 实模式和保护模式


### 实模式

* 8086CPU

数据总线：16位

控制总线：16位

地址总线：20位，通过CS和IP两个寄存器拼接出20位的地址，CS << 4 + IP，CS + IP称为逻辑地址


* 实模式缺点

1. 段大小受限制：16位offset决定段最大只能位64K（这其实模式实模式的缺点，即使是保护模式，如果offset是16位，依然有这个问题）
2. 不保证地址隔离：段之间可以互相访问，比如数据段可以访问到代码段
3. 程序运行时的地址不确定：


### 保护模式

保护模式定义段基地址、地址范围、和特权级，这样的数据结构成为描述符。判断地址是否在允许范围内，判断当前程序是否有权访问

* 保护模式的索引过程

1. 寄存器中存储段选择子（Segment Selector），段选择子为16位
段选择子结构：
 --------------------------------------------------
｜ 13位索引号 | T1 1位 标示GDT/LDT | RPL 2位 标示特权级 ｜
 --------------------------------------------------
2. 从GDT表中寻找段选择子中的索引，找到段描述符
段描述符结构： 
 ------------------------------------
｜ 32位存放段基地址 ｜ 32位存放段界限等信息 ｜
 ------------------------------------
3. 从段描述符中取出段基地址，使用段基地址 + 偏移量得到线性地址
4. 如果未开启分页，则线性地址为物理地址，可以被送上地址总线
5. 如果开启分页，则将线性地址分为三段，根据顶级页表、二级页表、页内偏移量在多级页表中查找页基地址，页基地址 + 页偏移量得到物理地址，将地址送上地址总线
